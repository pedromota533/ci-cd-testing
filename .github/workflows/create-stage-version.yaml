name: Deploymet enviroment
on:
    workflow_dispatch:
        inputs:
            version:
                description: "Git tag to deploy"
                type: string
                required: true
            environment:
                description: "Target environment"
                type: choice
                required: true
                options:
                    - qua
                    - prd

# Validate the tag exits; Not doing it right know
# checkout tag; Done
# compile with gcc; DONE
# run valgrind test; DONE
# build docker image; ???
# ?? Tag image as ghcr.io/{{ github.repository }}/c-valgrind:{{ environment }}-{{ version }}

jobs:
    build:
        runs-on: self-hosted
        permissions:
            contents: read
            packages: write
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  ref: ${{ inputs.version }}
            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}
            - name: Build and push image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  push: true
                  target: production # or build, depending on environment
                  tags: ghcr.io/${{ github.repository }}/c-valgrind:${{ inputs.environment }}-${{ inputs.version }}
